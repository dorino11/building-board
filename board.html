<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>לוח מודעות דיגיטלי</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --card:#121826;
      --muted:#97a0b5;
      --text:#e8eefc;
      --accent:#4da3ff;
      --danger:#ff6b6b;
      --radius:18px;
      --news-height:52px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:Heebo,Arial,sans-serif;
      overflow-x:hidden;
    }

    .wrap{
      min-height:100vh;
      max-width:1200px;
      margin:0 auto;
      padding:28px;
      padding-bottom:calc(var(--news-height) + 24px);
      display:flex;
      flex-direction:column;
    }

    /* ===== HEADER ===== */
    header{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:flex-start;
      gap:16px;
      margin-bottom:12px;
    }
    .title{
      font-size:44px;
      font-weight:800;
    }
    .title[contenteditable="true"]{
      outline:2px dashed rgba(255,255,255,.15);
      outline-offset:4px;
    }
    .clock{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      text-align:right;
    }
    .time{
      font-size:52px;
      font-weight:800;
      line-height:1;
    }
    .date{
      font-size:18px;
      color:var(--muted);
      margin-top:4px;
    }
    .weather-inline{
      font-size:16px;
      color:var(--muted);
      margin-top:4px;
    }

    /* ===== SHABBAT BAR ===== */
    .shabbat-wide{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px 18px;
      margin:10px 0 14px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
    }
    .shab-title{
      margin:0 0 8px 0;
      font-size:22px;
    }
    .shab-row{
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      align-items:center;
    }
    .shab-chip{
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(255,255,255,.04);
      padding:8px 14px;
      border-radius:999px;
    }
    .label{color:var(--muted)}
    .value{font-weight:700}

    /* ===== BOARD ===== */
    .board{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      min-height:300px;
      flex:1;
    }
    .board h2{
      margin:0 0 10px;
      font-size:22px;
    }

    /* פריסה: 75% הודעות + 25% תמונת סטורי */
    .board-layout{
      display:flex;
      gap:18px;
      align-items:stretch;
    }
    .board-main{
      flex:3;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .board-side{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .side-title{
      margin:0 0 6px;
      font-size:16px;
      color:var(--muted);
    }

    .msgs-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .btn{
      background:transparent;
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      padding:9px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      font-family:Heebo,Arial,sans-serif;
      transition:all 0.2s;
    }
    .btn:hover{
      border-color:rgba(255,255,255,.3);
      background:rgba(255,255,255,.04);
    }
    .btn:active{
      transform:scale(0.98);
    }

    .msg-board{
      position:relative;
      isolation:isolate;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      padding:12px;
      overflow-y:auto;
      overflow-x:hidden;
      min-height:200px;
      flex:1;
    }
    .msg-board::before{
      content:"";
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(1200px 220px at 10% 20%, rgba(77,163,255,.07), transparent 55%),
        radial-gradient(800px 200px at 90% 80%, rgba(53,211,153,.06), transparent 60%);
      filter:blur(10px);
      z-index:-1;
      animation:pan 25s linear infinite;
      pointer-events:none;
    }
    @keyframes pan{
      0%{transform:translateX(0)}
      50%{transform:translateX(-4%)}
      100%{transform:translateX(0)}
    }

    .msgs{
      display:grid;
      gap:12px;
      position:relative;
      z-index:1;
    }
    .msg{
      background:rgba(0,0,0,.18);
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
      opacity:0;
      transform:translateY(8px);
      animation:fadeUp .4s ease forwards;
    }
    .msg .text{
      font-size:18px;
      line-height:1.6;
      outline:none;
    }
    .msg .text[contenteditable="true"]{
      cursor:text;
    }
    @keyframes fadeUp{
      to{opacity:1;transform:none}
    }

    /* צד – תמונת סטורי */
    .ad-frame{
      position:relative;
      width:100%;
      aspect-ratio:9/16; /* סטורי אינסטגרם */
      border-radius:16px;
      background:rgba(0,0,0,.18);
      box-shadow:0 6px 14px rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .ad-frame img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }
    .ad-placeholder{
      font-size:13px;
      color:var(--muted);
      text-align:center;
      padding:8px;
    }
    .ad-upload-label{
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.25);
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      gap:6px;
    }
    .ad-upload-label input{
      display:none;
    }
    body.display .ad-upload-label{
      display:none;
    }

    /* ===== DISPLAY MODE – קרוסלה ===== */
    body.display .msgs-toolbar{
      display:none !important;
    }
    body.display .msg-board{
      overflow:hidden;
    }
    body.display .msgs{
      display:none !important;
    }
    body.display .viewer{
      display:block !important;
    }

    .viewer{
      display:none;
      position:relative;
      height:100%;
      z-index:2;
    }

    /* נראה בדיוק כמו .msg */
    .viewer-item{
      display:none;
      background:rgba(0,0,0,.18);
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
      font-size:18px;
      line-height:1.6;
      text-align:right;
      word-wrap:break-word;
      opacity:0;
      transform:translateY(8px);
      transition:opacity .4s ease, transform .4s ease;
    }
    .viewer-item.active{
      display:block;
      opacity:1;
      transform:translateY(0);
    }

    /* ===== NEWS BAR – גלילה רציפה ===== */
    .newsbar{
      position:fixed;
      inset-inline:0;
      bottom:0;
      height:var(--news-height);
      background:rgba(0,0,0,.9);
      color:#fff;
      z-index:9999;
      border-top:1px solid rgba(255,255,255,.25);
      overflow:hidden;
    }
    .news-inner{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:row;
      align-items:center;
      gap:0;
    }
    .news-label{
      background:var(--accent);
      padding:6px 26px;
      border-radius:0;
      font-weight:800;
      font-size:18px;
      white-space:nowrap;
      box-shadow:0 -2px 6px rgba(0,0,0,.45);
      flex-shrink:0;
      height:100%;
      display:flex;
      align-items:center;
      z-index:2;
    }
    .news-track{
      flex:1;
      overflow:hidden;
      position:relative;
      height:100%;
    }
    .news-content{
      display:flex;
      align-items:center;
      height:100%;
      white-space:nowrap;
      padding-inline-start:20px;
      will-change:transform;
    }
    .news-item{
      font-size:16px;
      white-space:nowrap;
      margin-inline-start:50px;
      flex-shrink:0;
    }
    .news-item a{
      color:#fff;
      text-decoration:none;
    }
    .news-item a:hover{
      text-decoration:underline;
    }

    @keyframes scroll-rtl{
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    .news-track:hover .news-content{
      animation-play-state:paused;
    }

    @media (max-width:992px){
      .board-layout{
        flex-direction:column;
      }
    }

    @media (max-width:768px){
      .wrap{padding:16px;padding-bottom:calc(var(--news-height) + 16px)}
      header{grid-template-columns:1fr}
      .title{text-align:center;font-size:32px}
      .clock{align-items:center}
      .time{font-size:40px}
      .news-label{font-size:16px;padding:4px 18px}
      .news-item{font-size:14px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title" id="boardTitle">לוח מודעות הבניין</div>
      <div class="clock">
        <div class="time" id="time">--:--</div>
        <div class="date" id="date">טוען…</div>
        <div class="weather-inline" id="weatherInline">מזג האוויר: —</div>
      </div>
    </header>

    <section class="shabbat-wide">
      <h2 class="shab-title">זמני שבת <small id="shabCity"></small></h2>
      <div class="shab-row">
        <div class="shab-chip">
          <span class="label">הדלקת נרות</span>
          <span class="value" id="candles">—</span>
        </div>
        <div class="shab-chip">
          <span class="label">צאת שבת</span>
          <span class="value" id="havdalah">—</span>
        </div>
      </div>
    </section>

    <section class="board">
      <h2>הודעות לדיירים</h2>

      <div class="board-layout">
        <div class="board-main">
          <div class="msgs-toolbar">
            <button type="button" class="btn" id="addMsg">הוסף הודעה</button>
            <button type="button" class="btn" id="toggleEdit">מצב עריכה</button>
            <button type="button" class="btn" id="clearAll">נקה הכול</button>
          </div>
          <div class="msg-board">
            <div class="msgs" id="msgs"></div>
            <div class="viewer" id="viewer"></div>
          </div>
        </div>

        <aside class="board-side">
          <h3 class="side-title">פינת מודעות</h3>
          <div class="ad-frame">
            <img id="adImage" alt="תמונת מודעה">
            <div class="ad-placeholder" id="adPlaceholder">
              העלה כאן תמונה בפורמט סטורי (1080×1920)
            </div>
          </div>
          <label class="ad-upload-label">
            <span>העלה תמונה</span>
            <input type="file" id="adUpload" accept="image/*">
          </label>
        </aside>
      </div>
    </section>
  </div>

  <div class="newsbar">
    <div class="news-inner">
      <div class="news-label">חדשות</div>
      <div class="news-track">
        <div class="news-content" id="newsContent">טוען חדשות...</div>
      </div>
    </div>
  </div>

<script>
const CONFIG = {
  locationName:'רחובות',
  latitude:31.8948,
  longitude:34.8090,
  tzid:'Asia/Jerusalem',
  candleOffsetMinutes:18,
  havdalahOffsetDeg:8.5
};

(function applyURLConfig(){
  const u = new URL(location.href);
  const city = u.searchParams.get('city');
  const lat  = parseFloat(u.searchParams.get('lat'));
  const lng  = parseFloat(u.searchParams.get('lng'));
  if(city) CONFIG.locationName = city;
  if(!isNaN(lat) && !isNaN(lng)){
    CONFIG.latitude = lat;
    CONFIG.longitude = lng;
  }
})();

const IS_DISPLAY = (() => {
  const p = new URLSearchParams(location.search);
  const v = p.get('display');
  return v === '1' || v === 'true';
})();

function updateClock(){
  const now = new Date();
  document.getElementById('time').textContent =
    now.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('date').textContent =
    now.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}
setInterval(updateClock,1000);
updateClock();

function wxCodeToHe(code){
  const map = {
    0:'שמיים בהירים',1:'מעונן חלקית',2:'מעונן',3:'מעונן כבד',
    45:'ערפל',48:'ערפל קפוא',
    51:'טפטוף קל',53:'טפטוף',55:'טפטוף חזק',
    61:'גשם קל',63:'גשם',65:'גשם חזק',
    71:'שלג קל',73:'שלג',75:'שלג כבד',
    80:'ממטרים קלים',81:'ממטרים',82:'ממטרים חזקים',
    95:'סופות רעמים',96:'סופה עם ברד',99:'סופה עם ברד כבד'
  };
  return map[code] || 'מעודכן';
}

async function loadWeather(){
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.latitude}&longitude=${CONFIG.longitude}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=${encodeURIComponent(CONFIG.tzid)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Weather fetch failed');
    const d = await res.json();
    const t = Math.round(d.current.temperature_2m);
    const w = d.current.weather_code;
    const max = Math.round(d.daily.temperature_2m_max[0]);
    const min = Math.round(d.daily.temperature_2m_min[0]);
    document.getElementById('weatherInline').textContent =
      `מזג האוויר: ${t}°C · ${wxCodeToHe(w)} · היום: ${min}°–${max}°`;
  }catch(e){
    document.getElementById('weatherInline').textContent = 'מזג האוויר לא זמין';
  }
}
loadWeather();
setInterval(loadWeather,30*60*1000);

const LS_KEYS = {
  title:'board.title',
  msgs:'board.msgs',
  edit:'board.edit',
  adImage:'board.adImage'
};

const titleEl = document.getElementById('boardTitle');
const msgsEl = document.getElementById('msgs');
const viewer = document.getElementById('viewer');
const addBtn = document.getElementById('addMsg');
const toggleBtn = document.getElementById('toggleEdit');
const clearBtn = document.getElementById('clearAll');
const adImg = document.getElementById('adImage');
const adPlaceholder = document.getElementById('adPlaceholder');
const adUpload = document.getElementById('adUpload');

function addMsgDOM(text){
  const card = document.createElement('div');
  card.className = 'msg';
  const t = document.createElement('div');
  t.className = 'text';
  t.textContent = text || '';
  card.appendChild(t);
  msgsEl.appendChild(card);

  if(!IS_DISPLAY){
    setTimeout(() => {
      card.scrollIntoView({behavior:'smooth',block:'end'});
    }, 50);
  }
}

function saveMsgs(){
  const arr = [...msgsEl.querySelectorAll('.msg .text')]
    .map(el => ({text: el.textContent.trim()}))
    .filter(m => m.text);
  localStorage.setItem(LS_KEYS.msgs, JSON.stringify(arr));
  if(IS_DISPLAY){
    buildCarousel();
  }
}

function setEdit(on){
  titleEl.setAttribute('contenteditable', on ? 'true' : 'false');
  msgsEl.querySelectorAll('.msg .text')
    .forEach(el => el.setAttribute('contenteditable', on ? 'true' : 'false'));
  if(toggleBtn){
    toggleBtn.textContent = on ? 'צא ממצב עריכה' : 'מצב עריכה';
  }
  localStorage.setItem(LS_KEYS.edit, JSON.stringify({edit:on}));
}

if(addBtn){
  addBtn.onclick = function(e){
    e.preventDefault();
    addMsgDOM('הודעה חדשה - לחץ כאן לעריכה');
    setEdit(true);
    saveMsgs();
  };
}

if(toggleBtn){
  toggleBtn.onclick = function(e){
    e.preventDefault();
    const isEditMode = toggleBtn.textContent === 'מצב עריכה';
    setEdit(isEditMode);
  };
}

if(clearBtn){
  clearBtn.onclick = function(e){
    e.preventDefault();
    if(confirm('למחוק את כל ההודעות?')){
      msgsEl.innerHTML = '';
      saveMsgs();
    }
  };
}

msgsEl.addEventListener('input', function(){
  saveMsgs();
});

function renderAdImage(){
  if(!adImg || !adPlaceholder) return;
  const data = localStorage.getItem(LS_KEYS.adImage);
  if(data){
    adImg.src = data;
    adImg.style.display = 'block';
    adPlaceholder.style.display = 'none';
  }else{
    adImg.removeAttribute('src');
    adImg.style.display = 'none';
    adPlaceholder.style.display = 'block';
  }
}

if(adUpload){
  adUpload.addEventListener('change', function(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        localStorage.setItem(LS_KEYS.adImage, ev.target.result);
      }catch(err){}
      renderAdImage();
    };
    reader.readAsDataURL(file);
  });
}

let titleSaveTimeout;
titleEl.addEventListener('input', function(){
  clearTimeout(titleSaveTimeout);
  titleSaveTimeout = setTimeout(() => {
    localStorage.setItem(LS_KEYS.title, titleEl.textContent.trim());
  }, 250);
});

let carouselTimer = null;
let carouselIndex = 0;

function buildCarousel(){
  if(!IS_DISPLAY) return;

  const items = [...msgsEl.querySelectorAll('.msg .text')]
    .map(el => el.textContent.trim())
    .filter(Boolean);

  viewer.innerHTML = '';

  if(items.length === 0){
    const empty = document.createElement('div');
    empty.className = 'viewer-item active';
    empty.textContent = 'אין הודעות להצגה';
    viewer.appendChild(empty);
    return;
  }

  items.forEach(text => {
    const el = document.createElement('div');
    el.className = 'viewer-item';
    el.textContent = text;
    viewer.appendChild(el);
  });

  carouselIndex = 0;
  activateCarouselItem(0);
}

function activateCarouselItem(i){
  const all = viewer.querySelectorAll('.viewer-item');
  all.forEach((el, idx) => {
    el.classList.toggle('active', idx === i);
  });
}

function startCarousel(){
  if(!IS_DISPLAY) return;
  buildCarousel();
  if(carouselTimer) clearInterval(carouselTimer);
  carouselTimer = setInterval(() => {
    const len = viewer.querySelectorAll('.viewer-item').length;
    if(len <= 1) return;
    carouselIndex = (carouselIndex + 1) % len;
    activateCarouselItem(carouselIndex);
  }, 8000);
}

(async function initBoard(){
  const t = localStorage.getItem(LS_KEYS.title);
  if(t) titleEl.textContent = t;

  let arr = JSON.parse(localStorage.getItem(LS_KEYS.msgs) || '[]');

  if(arr.length === 0){
    arr = [
      {text: 'ברוכים הבאים ללוח המודעות הדיגיטלי'},
      {text: 'להוספת הודעות הסר את ?display=1 מהכתובת'}
    ];
    localStorage.setItem(LS_KEYS.msgs, JSON.stringify(arr));
  }

  arr.forEach(m => addMsgDOM(m.text));

  const cityEl = document.getElementById('shabCity');
  cityEl.textContent = `– ${CONFIG.locationName}`;

  renderAdImage();

  if(!IS_DISPLAY){
    try{
      const ed = JSON.parse(localStorage.getItem(LS_KEYS.edit) || '{}');
      if(ed.edit) setEdit(true);
    }catch(e){}
  } else {
    document.body.classList.add('display');
    titleEl.setAttribute('contenteditable', 'false');
    setTimeout(startCarousel, 100);
  }

  loadShabbat();
  loadNews();
})();

async function loadShabbat(){
  const candlesEl = document.getElementById('candles');
  const havdalahEl = document.getElementById('havdalah');

  try{
    const params = new URLSearchParams({
      cfg:'json',
      latitude:String(CONFIG.latitude),
      longitude:String(CONFIG.longitude),
      tzid:CONFIG.tzid,
      m:String(CONFIG.havdalahOffsetDeg),
      b:String(CONFIG.candleOffsetMinutes)
    });
    const res = await fetch('https://www.hebcal.com/shabbat?' + params.toString());
    if(!res.ok) throw new Error('Shabbat fetch failed');
    const data = await res.json();
    const now = Date.now();
    const items = (data.items || []).filter(i => ['candles','havdalah'].includes(i.category));

    const nextCandles = items.filter(i => i.category === 'candles')
      .map(x => ({t:new Date(x.date).getTime()}))
      .sort((a,b)=>a.t-b.t)
      .find(x => x.t >= now);

    const nextHavdalah = items.filter(i => i.category === 'havdalah')
      .map(x => ({t:new Date(x.date).getTime()}))
      .sort((a,b)=>a.t-b.t)
      .find(x => x.t >= now);

    candlesEl.textContent = nextCandles
      ? new Date(nextCandles.t).toLocaleString('he-IL',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'})
      : '—';
    havdalahEl.textContent = nextHavdalah
      ? new Date(nextHavdalah.t).toLocaleString('he-IL',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'})
      : '—';
  }catch(e){
    candlesEl.textContent = 'לא זמין';
    havdalahEl.textContent = 'לא זמין';
  }
}
setInterval(loadShabbat,6*60*60*1000);

let newsHeadlines = [];

async function fetchRSSWithProxy(rssUrl){
  try {
    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(rssUrl);
    const res = await fetch(proxyUrl);
    if(!res.ok) throw new Error('RSS fetch failed');
    const text = await res.text();

    const parser = new DOMParser();
    const xml = parser.parseFromString(text, 'text/xml');
    const items = xml.querySelectorAll('item');

    const headlines = [];
    items.forEach((item, idx) => {
      // נאסוף הרבה, המסנן ל-40 יהיה אחר כך
      const title = item.querySelector('title')?.textContent;
      const link = item.querySelector('link')?.textContent;
      if(title && link) {
        headlines.push({t: title, u: link});
      }
    });

    return headlines;
  } catch(e) {
    return [];
  }
}

function renderNewsScroll(){
  const content = document.getElementById('newsContent');

  if(!newsHeadlines.length){
    content.innerHTML = '<span class="news-item">טוען חדשות...</span>';
    content.style.animation = 'none';
    return;
  }

  // דואג שיהיו לפחות 40 כותרות בלופ
  let filled = [];
  while(filled.length < 40){
    filled = filled.concat(newsHeadlines);
  }

  const itemsHTML = filled.map(h =>
    `<span class="news-item">• <a href="${h.u}" target="_blank" rel="noopener">${h.t.replace(/[<>"']/g,'')}</a></span>`
  ).join('');

  // משכפלים פעמיים – כדי שה-50% באנימציה יעבוד אינסופית
  content.innerHTML = itemsHTML + itemsHTML;

  requestAnimationFrame(() => {
    const fullWidth = content.scrollWidth / 2; // רוחב סט אחד
    const speed = 90; // ככל שיותר גדול – יותר מהיר
    const duration = fullWidth / speed;
    content.style.animation = `scroll-rtl ${duration}s linear infinite`;
  });
}

async function loadNews(){
  const sources = [
    // N12 / mako – חדשות
    'https://rcs.mako.co.il/rss/31750a2610f26110VgnVCM1000005201000aRCRD.xml'
  ];

  let headlines = [];

  for(const src of sources){
    const items = await fetchRSSWithProxy(src);
    headlines = headlines.concat(items);
  }

  const seen = new Set();
  const dedup = [];
  for(const h of headlines){
    if(!h.t || seen.has(h.t)) continue;
    seen.add(h.t);
    dedup.push(h);
    if(dedup.length >= 40) break; // 40 ייחודיות לכל היותר
  }

  newsHeadlines = dedup.length > 0 ? dedup : [{t:'אין חדשות זמינות כרגע', u:'#'}];
  renderNewsScroll();
}
setInterval(loadNews,15*60*1000);
</script>
</body>
</html>
