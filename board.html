<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>לוח מודעות דיגיטלי</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --card:#121826;
      --muted:#97a0b5;
      --text:#e8eefc;
      --accent:#4da3ff;
      --danger:#ff6b6b;
      --radius:18px;
      --news-height:60px;
      --news-speed:20s; 
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Heebo,Arial,sans-serif;}
    .wrap{min-height:100%;display:flex;flex-direction:column;max-width:1200px;margin:0 auto;padding:28px;padding-bottom:calc(var(--news-height) + 20px);box-sizing: border-box;}
    header{display:grid;grid-template-columns:1fr auto;align-items:center;margin-bottom:12px}
    .title{font-size:42px;font-weight:800}
    .clock{display:flex;flex-direction:column;align-items:flex-end}
    .time{font-size:52px;font-weight:800;line-height:1}
    .date{font-size:18px;color:var(--muted)}
    .weather-inline{font-size:16px;color:var(--muted);margin-top:4px}
    .shabbat-wide{background:var(--card);border-radius:var(--radius);padding:16px 18px;box-shadow:0 12px 30px rgba(0,0,0,.25);margin:6px 0 12px}
    .shab-row{display:flex;gap:22px;flex-wrap:wrap;align-items:baseline}
    .shab-title{font-size:22px;margin:0 0 8px 0}
    .shab-chip{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.05);padding:10px 14px;border-radius:12px}
    .label{color:var(--muted)}
    .value{font-weight:800}
    
    /* עדכון: הסתרת גלילה במיכל ההודעות */
    .board{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.25);display:flex;flex-direction:column;min-height:0;flex:1; overflow: hidden;}
    
    .msgs-toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,.16);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    
    .msg-board{position:relative;isolation:isolate;border-radius:14px;background:rgba(255,255,255,.03);padding:12px;overflow:hidden;min-height:0;flex:1}
    .msg-board::before{content:"";position:absolute;inset:-20%;background:radial-gradient(1200px 220px at 10% 20%, rgba(77,163,255,.07), transparent 55%), radial-gradient(800px 200px at 90% 80%, rgba(53,211,153,.06), transparent 60%);filter:blur(10px);z-index:-1;animation:pan 25s linear infinite}
    @keyframes pan{0%{transform:translateX(0)}50%{transform:translateX(-4%)}100%{transform:translateX(0)}}
    
    /* עדכון: שינוי תצוגה כדי לתמוך בהחלפת הודעות */
    .msgs{display:flex; flex-direction: column; gap:16px; padding-bottom: 20px; transition: transform 0.5s ease;}
    
    .msg{background:rgba(0,0,0,.18);padding:20px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,.18);opacity:0;transform:translateY(8px);animation:fadeUp .5s ease forwards; flex-shrink: 0;}
    .msg .text{font-size:24px;line-height:1.4; font-weight: 500;} 
    @keyframes fadeUp{to{opacity:1;transform:none}}
    
    .newsbar{position:fixed;inset-inline:0;bottom:0;height:var(--news-height);background:rgba(0,0,0,.85);color:#fff;z-index:9999;border-top:1px solid rgba(255,255,255,.2); display: flex;}
    .news-inner{width: 100%; height:100%;display:flex;align-items:center; padding:0;}
    
    .news-label{
        font-weight:800; 
        font-size: 20px;
        background: var(--accent);
        height: 100%;
        display: flex;
        align-items: center;
        padding: 0 30px;
        box-shadow: 4px 0 15px rgba(0,0,0,0.5);
        z-index: 10;
        position: relative;
    }
    
    .news-track{white-space:nowrap;animation:newsMarquee var(--news-speed) linear infinite; flex: 1; overflow: hidden; display: flex; align-items: center; height: 100%;}
    
    .news-item{display:inline-block;margin:0 40px;font-size:24px; font-weight: 300;}
    .news-item a{color:#fff;text-decoration:none}
    
    @keyframes newsMarquee{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
    
    body.display .msgs-toolbar{display:none!important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title" id="boardTitle" contenteditable>לוח מודעות הבניין</div>
      <div class="clock">
        <div class="time" id="time">--:--</div>
        <div class="date" id="date">טוען…</div>
        <div class="weather-inline" id="weatherInline">מזג האוויר: —</div>
      </div>
    </header>
    <section class="shabbat-wide">
      <h2 class="shab-title">זמני שבת <small id="shabCity"></small></h2>
      <div class="shab-row">
        <div class="shab-chip"><span class="label">הדלקת נרות</span><span class="value" id="candles">—</span></div>
        <div class="shab-chip"><span class="label">צאת שבת</span><span class="value" id="havdalah">—</span></div>
      </div>
    </section>
    <section class="board">
      <h2>הודעות לדיירים</h2>
      <div class="msgs-toolbar">
        <button class="btn" id="addMsg">הוסף הודעה</button>
        <button class="btn" id="toggleEdit">מצב עריכה</button>
        <button class="btn" id="clearAll">נקה הכול</button>
      </div>
      <div class="msg-board" id="msgBoardContainer">
        <div class="msgs" id="msgs"></div>
      </div>
    </section>
  </div>
  
  <div class="newsbar">
      <div class="news-inner">
          <div class="news-label">חדשות</div>
          <div class="news-track" id="newsTrack">טוען…</div>
      </div>
  </div>

<script>
const CONFIG={locationName:'רחובות',latitude:31.8948,longitude:34.8090,tzid:'Asia/Jerusalem',candleOffsetMinutes:18,havdalahOffsetDeg:8.5};
function updateClock(){const now=new Date();document.getElementById('time').textContent=now.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});document.getElementById('date').textContent=now.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long',year:'numeric'});}setInterval(updateClock,1000);updateClock();
function wxCodeToHe(c){const m={0:'שמיים בהירים',1:'מעונן חלקית',2:'מעונן',3:'מעונן כבד',45:'ערפל',48:'ערפל קפוא',51:'טפטוף קל',53:'טפטוף',55:'טפטוף חזק',61:'גשם קל',63:'גשם',65:'גשם חזק',71:'שלג קל',73:'שלג',75:'שלג כבד',80:'ממטרים קלים',81:'ממטרים',82:'ממטרים חזקים',95:'סופות רעמים',96:'סופה עם ברד',99:'סופה עם ברד כבד'};return m[c]||'מעודכן'}
async function loadWeather(){try{const u=`https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.latitude}&longitude=${CONFIG.longitude}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=${encodeURIComponent(CONFIG.tzid)}`;const r=await fetch(u);if(!r.ok) throw 0;const d=await r.json();const t=Math.round(d.current.temperature_2m);const code=d.current.weather_code;const max=Math.round(d.daily.temperature_2m_max[0]);const min=Math.round(d.daily.temperature_2m_min[0]);document.getElementById('weatherInline').textContent=`מזג האוויר: ${t}°C · ${wxCodeToHe(code)} · היום: ${min}°–${max}°`}catch(e){document.getElementById('weatherInline').textContent='מזג האוויר לא זמין'}}
loadWeather();setInterval(loadWeather,1800000);

const LS_KEYS={title:'board.title',msgs:'board.msgs',edits:'board.edit'};const titleEl=document.getElementById('boardTitle');const msgsEl=document.getElementById('msgs');const addBtn=document.getElementById('addMsg');const toggleBtn=document.getElementById('toggleEdit');(function(){const t=localStorage.getItem(LS_KEYS.title);if(t) titleEl.textContent=t;const arr=JSON.parse(localStorage.getItem(LS_KEYS.msgs)||'[]');arr.forEach(m=>addMsgDOM(m.text))})();let titleSaveTimeout;['input','blur'].forEach(ev=>titleEl.addEventListener(ev,()=>{clearTimeout(titleSaveTimeout);titleSaveTimeout=setTimeout(()=>localStorage.setItem(LS_KEYS.title,titleEl.textContent.trim()),300)}));
function addMsgDOM(text){const card=document.createElement('div');card.className='msg';const t=document.createElement('div');t.className='text';t.textContent=text||'טקסט ההודעה…';card.append(t);msgsEl.append(card);}
function saveMsgs(){const arr=[...msgsEl.querySelectorAll('.msg .text')].map(el=>({text:el.textContent.trim()}));localStorage.setItem(LS_KEYS.msgs,JSON.stringify(arr))}
function setEdit(v){titleEl.setAttribute('contenteditable',v);msgsEl.querySelectorAll('.msg .text').forEach(el=>el.setAttribute('contenteditable',v));toggleBtn.textContent=v?'צא ממצב עריכה':'מצב עריכה';localStorage.setItem(LS_KEYS.edits,JSON.stringify({edit:v}))}
try{const ed=JSON.parse(localStorage.getItem(LS_KEYS.edits)||'{}');if(ed.edit) setEdit(true)}catch{}
if(addBtn) addBtn.addEventListener('click',()=>{addMsgDOM();setEdit(true);saveMsgs()});if(toggleBtn) toggleBtn.addEventListener('click',()=>setEdit(toggleBtn.textContent==='מצב עריכה'));document.getElementById('clearAll').addEventListener('click',()=>{if(confirm('למחוק את כל ההודעות?')){msgsEl.innerHTML='';saveMsgs()}});msgsEl.addEventListener('input',saveMsgs);

const cityEl=document.getElementById('shabCity');const candlesEl=document.getElementById('candles');const havdalahEl=document.getElementById('havdalah');cityEl.textContent=`– ${CONFIG.locationName}`;async function loadShabbat(){try{const p=new URLSearchParams({cfg:'json',latitude:String(CONFIG.latitude),longitude:String(CONFIG.longitude),tzid:CONFIG.tzid,m:String(CONFIG.havdalahOffsetDeg),b:String(CONFIG.candleOffsetMinutes)});const r=await fetch(`https://www.hebcal.com/shabbat?${p.toString()}`);if(!r.ok) throw 0;const d=await r.json();const now=Date.now();const items=(d.items||[]).filter(i=>['candles','havdalah'].includes(i.category));const nextCandles=items.filter(i=>i.category==='candles').map(x=>({t:new Date(x.date).getTime()})).sort((a,b)=>a.t-b.t).find(x=>x.t>=now);const nextHavdalah=items.filter(i=>i.category==='havdalah').map(x=>({t:new Date(x.date).getTime()})).sort((a,b)=>a.t-b.t).find(x=>x.t>=now);candlesEl.textContent= nextCandles? new Date(nextCandles.t).toLocaleString('he-IL',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'}) : '—';havdalahEl.textContent= nextHavdalah? new Date(nextHavdalah.t).toLocaleString('he-IL',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'}) : '—'}catch(e){candlesEl.textContent='לא זמין';havdalahEl.textContent='לא זמין'}}
loadShabbat();setInterval(loadShabbat,21600000);

// --- קוד חדשות מעודכן עם יותר מקורות ---
async function fetchRSSJson(u){
    // הוספת פרמטר זמן כדי למנוע שמירה בזיכרון ולקבל חדשות טריות
    const noCacheUrl = u + (u.includes('?') ? '&' : '?') + 't=' + Date.now();
    const api='https://api.rss2json.com/v1/api.json?rss_url='+encodeURIComponent(noCacheUrl);
    const r=await fetch(api);
    if(!r.ok) throw 0;
    const d=await r.json();
    return d.items||[]
}

async function loadNews(){
  // הוספתי את N12 ואת ישראל היום לרשימה
  const s=[
      'https://www.ynet.co.il/Integration/StoryRss2.xml',
      'https://rss.walla.co.il/feed/1?type=main',
      'https://rccs.mako.co.il/rss/31750a2610f26110VgnVCM1000005201000aRCRD.xml', // N12
      'https://www.israelhayom.co.il/rss.xml' // Israel Hayom
  ];
  
  let h=[];
  for(const u of s){
    try{
      const i=await fetchRSSJson(u);
      h=h.concat(i.map(it=>({t:it.title,u:it.link})));
    }catch(e){}
  }
  
  const seen=new Set();
  const dedup=[];
  for(const x of h){
    if(!x.t||seen.has(x.t)) continue;
    seen.add(x.t);
    dedup.push(x);
    // הגדלתי משמעותית את כמות החדשות
    if(dedup.length>=100) break;
  }
  
  const track=document.getElementById('newsTrack');
  const newsHtml = dedup.length? dedup.map(h=>`<span class='news-item'>• ${h.t}</span>`).join('') : 'אין חדשות';
  track.innerHTML= newsHtml + newsHtml;
}
loadNews();setInterval(loadNews,900000);

(function(){const u=new URL(location.href);const disp=u.searchParams.get('display');if(disp==='1'||disp==='true') document.body.classList.add('display')})();
(function(){const u=new URL(location.href);const c=u.searchParams.get('city');const lat=parseFloat(u.searchParams.get('lat'));const lng=parseFloat(u.searchParams.get('lng'));if(c) CONFIG.locationName=c;if(!Number.isNaN(lat)&&!Number.isNaN(lng)){CONFIG.latitude=lat;CONFIG.longitude=lng}document.getElementById('shabCity').textContent=`– ${CONFIG.locationName}`})();

// --- קרוסלת הודעות חכמה (לפי דרישה) ---
function startMessageCarousel() {
    setInterval(() => {
        // בדיקה: האם המשתמש במצב עריכה? אם כן, עוצרים.
        if(document.getElementById('toggleEdit').textContent === 'צא ממצב עריכה') return;

        const msgsContainer = document.getElementById('msgs');
        const msgs = msgsContainer.children;

        // הדרישה: רק אם יש יותר מ-6 הודעות
        if (msgs.length > 6) {
            // לוקחים את ההודעה הראשונה
            const firstMsg = msgs[0];
            
            // מעבירים אותה לסוף הרשימה (זה קורה מיידית ב-DOM)
            msgsContainer.appendChild(firstMsg);
            
            // אפשר להוסיף אנימציה בעתיד, כרגע זה פשוט קופץ לסוף כמו שביקשת
        }
    }, 10000); // כל 10 שניות
}

// הפעלת הקרוסלה
startMessageCarousel();
</script>
</body>
</html>
