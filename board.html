<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>לוח מודעות דיגיטלי</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --card:#121826;
      --muted:#97a0b5;
      --text:#e8eefc;
      --accent:#4da3ff;
      --danger:#ff6b6b;
      --radius:18px;
      --news-height:52px;
    }

    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Heebo,Arial,sans-serif;
    }

    .wrap{
      min-height:100%;
      max-width:1200px;
      margin:0 auto;
      padding:28px;
      padding-bottom:calc(var(--news-height) + 24px);
      display:flex;
      flex-direction:column;
      box-sizing:border-box;
    }

    /* ===== HEADER ===== */
    header{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:flex-start;
      gap:16px;
      margin-bottom:12px;
    }
    .title{
      font-size:44px;
      font-weight:800;
    }
    .title[contenteditable="true"]{
      outline:2px dashed rgba(255,255,255,.15);
      outline-offset:4px;
    }
    .clock{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      text-align:right;
    }
    .time{
      font-size:52px;
      font-weight:800;
      line-height:1;
    }
    .date{
      font-size:18px;
      color:var(--muted);
      margin-top:4px;
    }
    .weather-inline{
      font-size:16px;
      color:var(--muted);
      margin-top:4px;
    }

    /* ===== SHABBAT BAR ===== */
    .shabbat-wide{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px 18px;
      margin:10px 0 14px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
    }
    .shab-title{
      margin:0 0 8px 0;
      font-size:22px;
    }
    .shab-row{
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      align-items:center;
    }
    .shab-chip{
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(255,255,255,.04);
      padding:8px 14px;
      border-radius:999px;
    }
    .label{color:var(--muted)}
    .value{font-weight:700}

    /* ===== BOARD ===== */
    .board{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      min-height:0;
      flex:1;
    }
    .board h2{
      margin:0 0 10px;
      font-size:22px;
    }
    .msgs-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .btn{
      background:transparent;
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      padding:9px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .btn:hover{
      border-color:rgba(255,255,255,.3);
      background:rgba(255,255,255,.04);
    }

    .msg-board{
      position:relative;
      isolation:isolate;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      padding:12px;
      overflow:visible;
      min-height:0;
      flex:1;
    }
    .msg-board::before{
      content:"";
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(1200px 220px at 10% 20%, rgba(77,163,255,.07), transparent 55%),
        radial-gradient(800px 200px at 90% 80%, rgba(53,211,153,.06), transparent 60%);
      filter:blur(10px);
      z-index:-1;
      animation:pan 25s linear infinite;
    }
    @keyframes pan{
      0%{transform:translateX(0)}
      50%{transform:translateX(-4%)}
      100%{transform:translateX(0)}
    }

    .msgs{
      display:grid;
      gap:12px;
    }
    .msg{
      background:rgba(0,0,0,.18);
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
      opacity:0;
      transform:translateY(8px);
      animation:fadeUp .4s ease forwards;
    }
    .msg .text{
      font-size:18px;
      line-height:1.6;
    }
    @keyframes fadeUp{
      to{opacity:1;transform:none}
    }

    /* ===== DISPLAY MODE – קרוסלה ===== */
    body.display .msgs-toolbar{display:none!important}
    body.display .msg-board{overflow:hidden}
    body.display .msgs{display:none}

    .viewer{
      position:absolute;
      inset:12px;
      display:grid;
      place-items:center;
      text-align:right;
    }
    .viewer-item{
      max-width:100%;
      opacity:0;
      transform:translateY(6px);
      transition:opacity .6s ease, transform .6s ease;
      font-size:28px;
      line-height:1.8;
      background:rgba(0,0,0,.18);
      padding:22px;
      border-radius:14px;
      box-shadow:0 6px 14px rgba(0,0,0,.2);
    }
    .viewer-item.active{
      opacity:1;
      transform:none;
    }

    /* ===== NEWS BAR – גלילה רציפה ===== */
    .newsbar{
      position:fixed;
      inset-inline:0;
      bottom:0;
      height:var(--news-height);
      background:rgba(0,0,0,.9);
      color:#fff;
      z-index:9999;
      border-top:1px solid rgba(255,255,255,.25);
      overflow:hidden;
    }
    .news-inner{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:row;
      align-items:center;
      box-sizing:border-box;
      gap:0;
    }
    .news-label{
      background:var(--accent);
      padding:6px 26px;
      border-radius:0;
      font-weight:800;
      font-size:18px;
      white-space:nowrap;
      box-shadow:0 -2px 6px rgba(0,0,0,.45);
      flex-shrink:0;
      height:100%;
      display:flex;
      align-items:center;
      position:relative;
      z-index:2;
      margin-inline-start:0;
      margin-inline-end:0;
    }
    .news-track{
      flex:1;
      overflow:hidden;
      position:relative;
      height:100%;
    }
    .news-content{
      display:flex;
      align-items:center;
      height:100%;
      white-space:nowrap;
      animation:scroll-rtl 60s linear infinite;
      padding-inline-start:20px;
      will-change:transform;
    }
    .news-item{
      font-size:16px;
      white-space:nowrap;
      margin-inline-start:50px;
      flex-shrink:0;
    }
    .news-item a{
      color:#fff;
      text-decoration:none;
    }
    .news-item a:hover{
      text-decoration:underline;
    }

    @keyframes scroll-rtl{
      0%{
        transform:translateX(0);
      }
      100%{
        transform:translateX(calc(-100% / 3));
      }
    }

    /* השהיית אנימציה בהובר */
    .news-track:hover .news-content{
      animation-play-state:paused;
    }

    @media (max-width:768px){
      .wrap{padding:16px;padding-bottom:calc(var(--news-height) + 16px)}
      header{grid-template-columns:1fr}
      .title{text-align:center}
      .clock{align-items:center}
      .viewer-item{font-size:22px}
      .news-label{font-size:16px;padding:4px 18px}
      .news-item{font-size:14px}
      .news-content{animation-duration:40s}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title" id="boardTitle" contenteditable>לוח מודעות הבניין</div>
      <div class="clock">
        <div class="time" id="time">--:--</div>
        <div class="date" id="date">טוען…</div>
        <div class="weather-inline" id="weatherInline">מזג האוויר: —</div>
      </div>
    </header>

    <!-- זמני שבת -->
    <section class="shabbat-wide">
      <h2 class="shab-title">זמני שבת <small id="shabCity"></small></h2>
      <div class="shab-row">
        <div class="shab-chip">
          <span class="label">הדלקת נרות</span>
          <span class="value" id="candles">—</span>
        </div>
        <div class="shab-chip">
          <span class="label">צאת שבת</span>
          <span class="value" id="havdalah">—</span>
        </div>
      </div>
    </section>

    <!-- הודעות לדיירים -->
    <section class="board">
      <h2>הודעות לדיירים</h2>
      <div class="msgs-toolbar">
        <button class="btn" id="addMsg">הוסף הודעה</button>
        <button class="btn" id="toggleEdit">מצב עריכה</button>
        <button class="btn" id="clearAll">נקה הכול</button>
      </div>
      <div class="msg-board">
        <div class="msgs" id="msgs"></div>
        <div class="viewer" id="viewer" aria-hidden="true"></div>
      </div>
    </section>
  </div>

  <!-- חדשות תחתון -->
  <div class="newsbar">
    <div class="news-inner">
      <div class="news-label">חדשות</div>
      <div class="news-track">
        <div class="news-content" id="newsContent">טוען חדשות...</div>
      </div>
    </div>
  </div>

<script>
/* ===== קונפיג ברירת מחדל – רחובות ===== */
const CONFIG = {
  locationName:'רחובות',
  latitude:31.8948,
  longitude:34.8090,
  tzid:'Asia/Jerusalem',
  candleOffsetMinutes:18,
  havdalahOffsetDeg:8.5
};

/* פרמטרים מה־URL (עיר/קואורדינטות) */
(function applyURLConfig(){
  const u = new URL(location.href);
  const city = u.searchParams.get('city');
  const lat  = parseFloat(u.searchParams.get('lat'));
  const lng  = parseFloat(u.searchParams.get('lng'));
  if(city) CONFIG.locationName = city;
  if(!Number.isNaN(lat) && !Number.isNaN(lng)){
    CONFIG.latitude = lat;
    CONFIG.longitude = lng;
  }
})();

/* זיהוי מצב תצוגה */
const IS_DISPLAY = (() => {
  const p = new URLSearchParams(location.search);
  const v = p.get('display');
  return v === '1' || v === 'true';
})();

/* ===== שעון ותאריך ===== */
function updateClock(){
  const now = new Date();
  document.getElementById('time').textContent =
    now.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('date').textContent =
    now.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}
setInterval(updateClock,1000); updateClock();

/* ===== מזג אוויר (IMS - השירות המטאורולוגי הישראלי) ===== */
async function loadWeather(){
  try{
    // קריאה ל-API של השירות המטאורולוגי
    const res = await fetch('https://ims.gov.il/sites/default/files/ims_data/xml_files/TM46_latest.xml', {cache:'no-store'});
    if(!res.ok) throw new Error('Failed to fetch');
    
    const text = await res.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, 'text/xml');
    
    // חיפוש התחנה הקרובה לרחובות - תחנת בית דגן
    const stations = xml.querySelectorAll('Location');
    let temp = null;
    let desc = 'נתונים לא זמינים';
    
    for(const station of stations){
      const name = station.querySelector('LocationMetaData LocationNameHeb')?.textContent;
      if(name && name.includes('בית דגן')){
        const tempEl = station.querySelector('BP_Temp');
        if(tempEl) temp = Math.round(parseFloat(tempEl.textContent));
        break;
      }
    }
    
    if(temp !== null){
      document.getElementById('weatherInline').textContent = `מזג האוויר: ${temp}°C`;
    } else {
      throw new Error('No data');
    }
  }catch(e){
    // נסיון חלופי עם Open-Meteo
    try{
      const url =
        `https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.latitude}&longitude=${CONFIG.longitude}` +
        `&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=${encodeURIComponent(CONFIG.tzid)}`;
      const res = await fetch(url,{cache:'no-store'});
      if(!res.ok) throw 0;
      const d = await res.json();
      const t   = Math.round(d.current.temperature_2m);
      const w   = d.current.weather_code;
      const max = Math.round(d.daily.temperature_2m_max[0]);
      const min = Math.round(d.daily.temperature_2m_min[0]);
      document.getElementById('weatherInline').textContent =
        `מזג האוויר: ${t}°C · ${wxCodeToHe(w)} · היום: ${min}°–${max}°`;
    }catch(e2){
      document.getElementById('weatherInline').textContent = 'מזג האוויר לא זמין';
    }
  }
}
/* ===== הודעות לדיירים – localStorage + קרוסלה ===== */
const LS_KEYS = {
  title:'board.title',
  msgs :'board.msgs',
  edit :'board.edit'
};

const titleEl = document.getElementById('boardTitle');
const msgsEl  = document.getElementById('msgs');
const viewer  = document.getElementById('viewer');
const addBtn  = document.getElementById('addMsg');
const toggleBtn = document.getElementById('toggleEdit');
const clearBtn  = document.getElementById('clearAll');

/* טעינה ראשונית */
(function initBoard(){
  const t = localStorage.getItem(LS_KEYS.title);
  if(t) titleEl.textContent = t;

  const arr = JSON.parse(localStorage.getItem(LS_KEYS.msgs) || '[]');
  arr.forEach(m => addMsgDOM(m.text));

  try{
    const ed = JSON.parse(localStorage.getItem(LS_KEYS.edit) || '{}');
    if(ed.edit) setEdit(true);
  }catch{}

  if(IS_DISPLAY) document.body.classList.add('display');
  startCarousel();
})();

/* שמירת כותרת */
let titleSaveTimeout;
['input','blur'].forEach(ev =>
  titleEl.addEventListener(ev, () => {
    clearTimeout(titleSaveTimeout);
    titleSaveTimeout = setTimeout(() => {
      localStorage.setItem(LS_KEYS.title, titleEl.textContent.trim());
    }, 250);
  })
);

function addMsgDOM(text){
  const card = document.createElement('div');
  card.className = 'msg';
  const t = document.createElement('div');
  t.className = 'text';
  t.textContent = text || '';
  card.appendChild(t);
  msgsEl.appendChild(card);
  if(!IS_DISPLAY){
    card.scrollIntoView({behavior:'smooth',block:'end'});
  }
}

function saveMsgs(){
  const arr = [...msgsEl.querySelectorAll('.msg .text')]
    .map(el => ({text: el.textContent.trim()}));
  localStorage.setItem(LS_KEYS.msgs, JSON.stringify(arr));
  buildCarousel();
}

function setEdit(on){
  titleEl.setAttribute('contenteditable', on);
  msgsEl.querySelectorAll('.msg .text')
    .forEach(el => el.setAttribute('contenteditable', on));
  if(toggleBtn){
    toggleBtn.textContent = on ? 'צא ממצב עריכה' : 'מצב עריכה';
  }
  localStorage.setItem(LS_KEYS.edit, JSON.stringify({edit:on}));
}

/* אירועים על כפתורים */
if(addBtn){
  addBtn.addEventListener('click', () => {
    addMsgDOM('');
    setEdit(true);
    saveMsgs();
  });
}
if(toggleBtn){
  toggleBtn.addEventListener('click', () => {
    setEdit(toggleBtn.textContent === 'מצב עריכה');
  });
}
if(clearBtn){
  clearBtn.addEventListener('click', () => {
    if(confirm('למחוק את כל ההודעות?')){
      msgsEl.innerHTML = '';
      saveMsgs();
    }
  });
}
msgsEl.addEventListener('input', saveMsgs);

/* קרוסלת הודעות למצב תצוגה */
let carouselTimer = null;
let carouselIndex = 0;

function getMessagesArray(){
  return [...msgsEl.querySelectorAll('.msg .text')]
    .map(el => el.textContent.trim())
    .filter(Boolean);
}

function buildCarousel(){
  if(!IS_DISPLAY) return;
  const items = getMessagesArray();
  viewer.innerHTML = '';
  if(items.length === 0){
    const empty = document.createElement('div');
    empty.className = 'viewer-item active';
    empty.textContent = '';
    viewer.appendChild(empty);
    return;
  }
  for(const text of items){
    const el = document.createElement('div');
    el.className = 'viewer-item';
    el.textContent = text;
    viewer.appendChild(el);
  }
  carouselIndex = 0;
  activateCarouselItem(0);
}

function activateCarouselItem(i){
  const all = [...viewer.querySelectorAll('.viewer-item')];
  all.forEach((el,idx) => el.classList.toggle('active', idx === i));
}

function startCarousel(){
  if(!IS_DISPLAY) return;
  buildCarousel();
  if(carouselTimer) clearInterval(carouselTimer);
  carouselTimer = setInterval(() => {
    const len = viewer.querySelectorAll('.viewer-item').length;
    if(len <= 1) return;
    carouselIndex = (carouselIndex + 1) % len;
    activateCarouselItem(carouselIndex);
  }, 10000);
}

/* ===== זמני שבת – Hebcal ===== */
const cityEl    = document.getElementById('shabCity');
const candlesEl = document.getElementById('candles');
const havdalahEl= document.getElementById('havdalah');
cityEl.textContent = `– ${CONFIG.locationName}`;

async function loadShabbat(){
  try{
    const params = new URLSearchParams({
      cfg:'json',
      latitude:String(CONFIG.latitude),
      longitude:String(CONFIG.longitude),
      tzid:CONFIG.tzid,
      m:String(CONFIG.havdalahOffsetDeg),
      b:String(CONFIG.candleOffsetMinutes)
    });
    const res = await fetch('https://www.hebcal.com/shabbat?' + params.toString(),{cache:'no-store'});
    if(!res.ok) throw 0;
    const data = await res.json();
    const now = Date.now();
    const items = (data.items || []).filter(i => ['candles','havdalah'].includes(i.category));

    const nextCandles = items.filter(i => i.category === 'candles')
      .map(x => ({t:new Date(x.date).getTime()}))
      .sort((a,b)=>a.t-b.t)
      .find(x => x.t >= now);

    const nextHavdalah = items.filter(i => i.category === 'havdalah')
      .map(x => ({t:new Date(x.date).getTime()}))
      .sort((a,b)=>a.t-b.t)
      .find(x => x.t >= now);

    candlesEl.textContent = nextCandles
      ? new Date(nextCandles.t).toLocaleString('he-IL',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'})
      : '—';
    havdalahEl.textContent = nextHavdalah
      ? new Date(nextHavdalah.t).toLocaleString('he-IL',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'})
      : '—';
  }catch(e){
    candlesEl.textContent  = 'לא זמין';
    havdalahEl.textContent = 'לא זמין';
  }
}
loadShabbat();
setInterval(loadShabbat,6*60*60*1000);

/* ===== חדשות – גלילה רציפה אינסופית ===== */
let newsHeadlines = [];

async function fetchRSSJson(rssUrl){
  const api = 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(rssUrl);
  const res = await fetch(api,{cache:'no-store'});
  if(!res.ok) throw 0;
  const data = await res.json();
  return data.items || [];
}

function renderNewsScroll(){
  const content = document.getElementById('newsContent');
  if(!newsHeadlines.length){
    content.innerHTML = '<span class="news-item">אין חדשות להצגה</span>';
    content.style.animation = 'none';
    return;
  }

  // יצירת HTML לכל הכותרות - כפול פי 3 לגלילה חלקה
  const itemsHTML = newsHeadlines.map(h => 
    `<span class="news-item">• <a href="${h.u}" target="_blank" rel="noopener">${h.t.replace(/"/g,'&quot;')}</a></span>`
  ).join('');
  
  // הכפלת התוכן פי 3 לגלילה רציפה אמיתית
  content.innerHTML = itemsHTML + itemsHTML + itemsHTML;
  
  // חישוב משך האנימציה לפי רוחב התוכן
  const contentWidth = content.scrollWidth / 3; // רוחב של העתק אחד
  const duration = contentWidth / 50; // 50 פיקסלים לשנייה
  content.style.animationDuration = `${duration}s`;
}

async function loadNews(){
  const sources = [
    'https://www.ynet.co.il/Integration/StoryRss2.xml',
    'https://rss.walla.co.il/feed/1?type=main'
  ];

  let headlines = [];

  for(const src of sources){
    try{
      const items = await fetchRSSJson(src);
      headlines = headlines.concat(
        items.slice(0,40).map(it => ({t:it.title,u:it.link}))
      );
    }catch(e){}
  }

  const seen = new Set();
  const dedup = [];
  for(const h of headlines){
    if(!h.t || seen.has(h.t)) continue;
    seen.add(h.t);
    dedup.push(h);
    if(dedup.length >= 40) break;
  }

  newsHeadlines = dedup;
  renderNewsScroll();
}

loadNews();
setInterval(loadNews,15*60*1000);
</script>
</body>
</html>
